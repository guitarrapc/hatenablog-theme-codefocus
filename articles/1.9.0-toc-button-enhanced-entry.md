---
title: CodeFocus v1.9.0 - ワイドスクリーン対応とパフォーマンス改善
---

CodeFocusテーマの[v1.9.0](https://github.com/guitarrapc/hatenablog-theme-codefocus/releases/tag/v1.9.0)をリリースしました。このバージョンでは、大画面での目次表示を大幅に改善し、パフォーマンスとメモリ管理も最適化しています。

[:contents]

## サマリー

v1.9.0では、[Zenn](https://zenn.dev/)のような大画面での常時表示目次機能を追加しました。横幅1540px以上の画面では、記事と目次が並んで表示され、長い技術記事でも全体構造を把握しながら読み進められます。

また、スクロールイベントの最適化によりCPU使用率を約83%削減し、メモリリーク対策により長時間の閲覧でも安定して動作するようになりました。

**主な改善点:**

- ワイドスクリーン(1540px以上)で目次を常時表示
- 複数記事ページでの目次自動切り替え
- スクロールイベントのスロットリングによるパフォーマンス改善
- イベントデリゲーションによるメモリリーク対策
- 長い目次での現在位置の自動スクロール表示

1540px以上のワイドスクリーンでの目次表示例:

[f:id:guitarrapc_tech:20260104190109p:plain:alt=ワイドスクリーンでのサイドバイサイド表示] <!-- screenshots/pc-wide-toc-sidebar.png -->

## アップデート方法

テーマストアから最新版のCodeFocusテーマは、自動的に更新されます。特別な操作は不要です。
目次ボタン機能を使っている場合は、以下のJavaScriptカスタマイズの更新手順を必ず実行してください。

### JavaScriptカスタマイズの更新（重要）

目次ボタン機能を使用している場合は、JavaScriptの更新が必要です。使用していない場合は、この手順をスキップしてください。

1. [customize-toc-button.html](https://github.com/guitarrapc/hatenablog-theme-codefocus/blob/main/customize-toc-button.html)の最新版をコピー
2. はてなブログの「デザイン」→「カスタマイズ」→「ヘッダ」→「ブログタイトル下」の既存のコードと置き換え
3. 変更を保存

> **注意**: JavaScriptを更新しないと、新機能が正しく動作しません。必ず最新版に更新してください。

## 新機能の詳細

### 1. ワイドスクリーンでのサイドバイサイド表示

横幅1540px以上の大画面では、目次が画面右側に常時表示されるようになりました。

**利点:**

- **記事と目次を同時に確認**: 長い記事でも全体構造を把握しながら読める
- **目次ボタンは自動的に非表示**: 常時表示されるため、ボタンは不要
- **レスポンシブ対応**: 画面を狭くすると自動的に通常モードに戻る

[f:id:guitarrapc_tech:20260104190109p:plain:alt=ワイドスクリーンでのサイドバイサイド表示] <!-- screenshots/pc-wide-toc-sidebar.png -->

この機能は、大きなモニターやワイドディスプレイで技術記事を読む際に特に便利です。

### 2. 複数記事ページでの自動判別

トップページやアーカイブページなど、複数の記事が1ページに表示される場合、スクロール位置に応じて目次が自動的に切り替わります。

**改善内容:**

- 現在の表示位置にある記事を自動判別
- その記事の目次を動的に表示
- スムーズな目次の切り替え

### 3. パフォーマンスの大幅改善

スクロールイベントの処理を最適化し、CPU使用率を大幅に削減しました。

**技術的な改善:**

- スクロールイベントを100msでスロットリング
- 処理頻度を60fps → 10fpsに削減
- CPU使用率を約83%削減

この改善により、長い記事をスクロールしてもブラウザの動作が重くなりません。

### 4. メモリリーク対策

イベントリスナーの管理方法を見直し、長時間の閲覧でもメモリ使用量が増え続ける問題を解決しました。

**技術的な改善:**

- 個別のイベントリスナーをイベントデリゲーションパターンに置き換え
- 目次の動的更新時にもリスナーが蓄積しない設計
- 長時間の閲覧でも安定した動作を保証

### 5. 長い目次での自動スクロール

目次が長い場合、現在読んでいるセクションが自動的に表示範囲内にスクロールされます。

**利点:**

- 長い目次でも現在位置を見失わない
- スムーズなスクロール動作
- 常に現在のセクションが見える位置に調整

## その他の技術的改善

### 定数の一元管理

すべてのマジックナンバーを定数として定義し、コードの可読性と保守性を向上させました：

```javascript
const CONSTANTS = {
  WIDE_SCREEN_WIDTH: 1540,      // ワイドスクリーン判定の閾値
  SCROLL_THROTTLE: 100,          // スクロールイベントのスロットリング間隔
  RESIZE_DEBOUNCE: 250,          // リサイズイベントのデバウンス間隔
  // その他の定数...
};
```

### テストカバレッジの向上

新機能に対応するPlaywrightテストを追加し、品質を保証しています：

- ワイドスクリーンでの目次表示テスト
- 解像度変更時の動作テスト
- 全21テストが成功

## 今後の予定

今後も以下のような改善を予定しています：

- さらなるパフォーマンス最適化
- アクセシビリティの向上
- ユーザーフィードバックに基づく機能改善

ご意見やご要望は、[GitHub Issues](https://github.com/guitarrapc/hatenablog-theme-codefocus/issues)にてお気軽にお寄せください。

---

*CodeFocusテーマをご利用いただき、ありがとうございます。今後もより良いテーマを目指して改善を続けていきます。*
